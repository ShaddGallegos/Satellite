---
# Comprehensive Role Testing Suite
# Purpose: Validate all Satellite roles functionality

- name: "Satellite Roles Comprehensive Test Suite"
  hosts: satellite_servers
  gather_facts: true
  vars:
    test_results: []

  tasks:
    - name: "Test 1: Satellite Build Role Validation"
      block:
        - name: Test satellite installation
          ansible.builtin.uri:
            url: "https://{{ inventory_hostname }}/api/ping"
            method: GET
            user: "{{ satellite_admin_user }}"
            password: "{{ satellite_admin_password }}"
            force_basic_auth: true
            validate_certs: false
          register: build_test
          ignore_errors: true

        - name: Record build test result
          ansible.builtin.set_fact:
            test_results: "{{ test_results + [{'test': 'Satellite Build', 'status': 'PASS' if build_test.status == 200 else 'FAIL', 'details': build_test.msg | default('N/A')}] }}"

    - name: "Test 2: PXE Services Validation"
      block:
        - name: Test TFTP service
          ansible.builtin.command: systemctl is-active tftp.socket
          register: tftp_test
          ignore_errors: true

        - name: Test DHCP service
          ansible.builtin.command: systemctl is-active dhcpd
          register: dhcp_test
          ignore_errors: true

        - name: Test LibVirt service
          ansible.builtin.command: systemctl is-active libvirtd
          register: libvirt_test
          ignore_errors: true

        - name: Record PXE services test results
          ansible.builtin.set_fact:
            test_results: "{{ test_results + [
              {'test': 'TFTP Service', 'status': 'PASS' if tftp_test.rc == 0 else 'FAIL', 'details': tftp_test.stdout},
              {'test': 'DHCP Service', 'status': 'PASS' if dhcp_test.rc == 0 else 'FAIL', 'details': dhcp_test.stdout},
              {'test': 'LibVirt Service', 'status': 'PASS' if libvirt_test.rc == 0 else 'FAIL', 'details': libvirt_test.stdout}
            ] }}"

    - name: "Test 3: Content Configuration Validation"
      block:
        - name: Test organization existence
          ansible.builtin.uri:
            url: "https://{{ inventory_hostname }}/api/organizations"
            method: GET
            user: "{{ satellite_admin_user }}"
            password: "{{ satellite_admin_password }}"
            force_basic_auth: true
            validate_certs: false
          register: org_test
          ignore_errors: true

        - name: Record content test result
          ansible.builtin.set_fact:
            test_results: "{{ test_results + [{'test': 'Content Configuration', 'status': 'PASS' if org_test.status == 200 else 'FAIL', 'details': 'API Response: ' + (org_test.status | string)}] }}"

    - name: "Display Test Results"
      ansible.builtin.debug:
        msg: |
          üß™ SATELLITE ROLES TEST RESULTS
          ================================
          
          {% for result in test_results %}
          {{ "‚úÖ" if result.status == "PASS" else "‚ùå" }} {{ result.test }}: {{ result.status }}
          {% if result.details != "N/A" %}   Details: {{ result.details }}{% endif %}
          {% endfor %}
          
          üìä Summary: {{ test_results | selectattr('status', 'equalto', 'PASS') | list | length }} PASS, {{ test_results | selectattr('status', 'equalto', 'FAIL') | list | length }} FAIL

    - name: "Generate Test Report"
      ansible.builtin.copy:
        content: |
          # Satellite Roles Test Report
          
          **Test Date**: {{ ansible_date_time.iso8601 }}
          **Target Server**: {{ inventory_hostname }}
          
          ## Test Results
          
          {% for result in test_results %}
          ### {{ result.test }}
          - **Status**: {{ result.status }}
          - **Details**: {{ result.details }}
          
          {% endfor %}
          
          ## Summary
          - **Total Tests**: {{ test_results | length }}
          - **Passed**: {{ test_results | selectattr('status', 'equalto', 'PASS') | list | length }}
          - **Failed**: {{ test_results | selectattr('status', 'equalto', 'FAIL') | list | length }}
          
          Generated by Satellite Roles Test Suite
        dest: "/tmp/satellite_roles_test_report.md"
        mode: '0644'
